<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Examples of existing models · NmodController</title><meta name="title" content="Examples of existing models · NmodController"/><meta property="og:title" content="Examples of existing models · NmodController"/><meta property="twitter:title" content="Examples of existing models · NmodController"/><meta name="description" content="Documentation for NmodController."/><meta property="og:description" content="Documentation for NmodController."/><meta property="twitter:description" content="Documentation for NmodController."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">NmodController</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Initializing a conductance based model</span><ul><li><a class="tocitem" href="../../initializing/current/">How to initialize an ionic current?</a></li><li><a class="tocitem" href="../../initializing/neuron/">How to initialize a conductance based model?</a></li><li><a class="tocitem" href="../../initializing/examples/">Examples of existing models</a></li></ul></li><li><span class="tocitem">Computing dynamical input conductances (DICs)</span><ul><li><a class="tocitem" href="../../computing/DICs/">How to compute DICs and sensitivity matrix?</a></li><li><a class="tocitem" href="../../computing/examples/">Examples of existing models</a></li></ul></li><li><span class="tocitem">Simulating with DifferentialEquations.jl</span><ul><li><a class="tocitem" href="../files/">How to write ODE functions file?</a></li><li class="is-active"><a class="tocitem" href>Examples of existing models</a><ul class="internal"><li><a class="tocitem" href="#Simulating-the-uncontrolled-STG-model"><span>Simulating the uncontrolled STG model</span></a></li><li><a class="tocitem" href="#Simulating-the-controlled-STG-model"><span>Simulating the controlled STG model</span></a></li><li><a class="tocitem" href="#Simulating-the-uncontrolled-DA-model"><span>Simulating the uncontrolled DA model</span></a></li><li><a class="tocitem" href="#Simulating-the-controlled-DA-model"><span>Simulating the controlled DA model</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../typesMethodsFunctions/">Types/Methods/Functions</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Simulating with DifferentialEquations.jl</a></li><li class="is-active"><a href>Examples of existing models</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Examples of existing models</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/arthur-fyon/NmodController.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/arthur-fyon/NmodController.jl/blob/main/docs/src/simulating/examples.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Example-on-existing-models-in-the-litterature"><a class="docs-heading-anchor" href="#Example-on-existing-models-in-the-litterature">Example on existing models in the litterature</a><a id="Example-on-existing-models-in-the-litterature-1"></a><a class="docs-heading-anchor-permalink" href="#Example-on-existing-models-in-the-litterature" title="Permalink"></a></h1><h2 id="Simulating-the-uncontrolled-STG-model"><a class="docs-heading-anchor" href="#Simulating-the-uncontrolled-STG-model">Simulating the uncontrolled STG model</a><a id="Simulating-the-uncontrolled-STG-model-1"></a><a class="docs-heading-anchor-permalink" href="#Simulating-the-uncontrolled-STG-model" title="Permalink"></a></h2><p>Once the STG model is initialized, simulated it can be simplified using <em>NmodController.jl</em>. At first, we will simulate the model <code>STG_spiking</code> that exhibits a tonic spiking behavior with</p><ul><li>sodium current: <span>$\bar{g}_\mathrm{Na} =$</span> 4000;</li><li>T-type calcium current: <span>$\bar{g}_\mathrm{CaT} =$</span> 3;</li><li>slow calcium current: <span>$\bar{g}_\mathrm{CaS} =$</span> 4;</li><li>A-type potassium current: <span>$\bar{g}_\mathrm{A} =$</span> 175;</li><li>calcium controlled potassium current: <span>$\bar{g}_\mathrm{KCa} =$</span> 110;</li><li>delayed rectified potassium current: <span>$\bar{g}_\mathrm{Kd} =$</span> 137;</li><li>H type current: <span>$\bar{g}_\mathrm{H} =$</span> 0.3;</li><li>leakage current: <span>$g_\mathrm{leak} =$</span> 0.01.</li></ul><p>The next few lines of code show how to simulate the spiking STG model using <em>NmodController.jl</em>.</p><pre><code class="language-julia hljs"># First writing uncontrolled ODE function file
writeUncontrolledODEs(STG_spiking, filename=&quot;STG_ODE.jl&quot;)

# Including the newly written file
include(&quot;STG_ODE.jl&quot;)

# Definition of simulation time (in ms)
Tfinal = 2000
tspan  = (0., Tfinal)

# Definition of membrane capacitance and maximal conductance values
gNa   = 4000. # Sodium current maximal conductance
gCaT  = 3. # T-type calcium current maximal conductance
gCaS  = 4. # Slow calcium current maximal conductance
gA    = 175. # A-type potassium current maximal conductance
gKCa  = 110. # Calcium-activated potassium current maximal conductance
gKd   = 137. # Delayed-rectifier potassium current maximal conductance
gH    = 0.3 # H-current maximal conductance
gleak = 0.01 # Leak current maximal conductance
C = 1. # Membrane capacitance

# Input current definition (always a function of time)
Iapp(t) = 0.

# Parameter vector for simulations
p = (Iapp, gNa, gCaT, gCaS, gA, gKCa, gKd, gH, gleak, C)

# Initial conditions
V0  = -70.
Ca0 = 0.5
x0  = [V0, STG_mNa_inf(V0), STG_hNa_inf(V0), STG_mCaT_inf(V0), STG_hCaT_inf(V0), STG_mCaS_inf(V0), 
      STG_hCaS_inf(V0), STG_mA_inf(V0), STG_hA_inf(V0), STG_mKCa_inf(V0, Ca0), STG_mKd_inf(V0), STG_mH_inf(V0), Ca0]

# Simulation
prob = ODEProblem(STG_ODE, x0, tspan, p) # Describing the problem
sol  = solve(prob) # Solving the problem

# Retrieving variables
tt        = 0. : 0.2 : Tfinal
x         = sol(tt)
V_plot   = x[1, :]

# Plot
p = plot(tt/1e3, V_plot, xlims=(0, 2), xticks=[0, 2], ylims=(-100, 60), yticks=[-100, 60], linewidth=1.5, 
          legend=false, size=(600, 200), color=:gray30, margins=20px, dpi=500)
ylabel!(&quot;V (mV)&quot;)
xlabel!(&quot;t (s)&quot;)</code></pre><p><img src="https://raw.githubusercontent.com/arthur-fyon/NmodController.jl/main/docs/src/assets/STG_simu_spiking.png" alt/></p><p>with <code>STG_ODE.jl</code> containing</p><pre><code class="language-julia hljs">#=
	This file contains differential equations describing the CB model of interest
=#

# Function that outputs values of variables derivatives
function STG_ODE(dx, x, p, t)
	# Parameters
	Iapp = p[1](t) # Time dependent applied current
	gNa = p[2] # Maximum conductance of current Na
	gCaT = p[3] # Maximum conductance of current CaT
	gCaS = p[4] # Maximum conductance of current CaS
	gA = p[5] # Maximum conductance of current A
	gKCa = p[6] # Maximum conductance of current KCa
	gKd = p[7] # Maximum conductance of current Kd
	gH = p[8] # Maximum conductance of current H
	gleak = p[9] # Leakage conductance
	C = p[10] # Membrane capacitance

	# Variables
	V = x[1] # Membrane voltage
	mNa = x[2] # Activation gating variable of current Na
	hNa = x[3] # Inactivation gating variable of current Na
	mCaT = x[4] # Activation gating variable of current CaT
	hCaT = x[5] # Inactivation gating variable of current CaT
	mCaS = x[6] # Activation gating variable of current CaS
	hCaS = x[7] # Inactivation gating variable of current CaS
	mA = x[8] # Activation gating variable of current A
	hA = x[9] # Inactivation gating variable of current A
	mKCa = x[10] # Activation gating variable of current KCa
	mKd = x[11] # Activation gating variable of current Kd
	mH = x[12] # Activation gating variable of current H
	Ca = x[13] # Ca concentration

	# ODEs
	dx[1] = (1/C) * (- gNa*mNa^3*hNa^1*(V - 50.0) -
					   gCaT*mCaT^3*hCaT^1*(V - 80.0) -
					   gCaS*mCaS^3*hCaS^1*(V - 80.0) -
					   gA*mA^3*hA^1*(V - -80.0) -
					   gKCa*mKCa^4*(V - -80.0) -
					   gKd*mKd^4*(V - -80.0) -
					   gH*mH^1*(V - -20.0) -
					   gleak*(V - -50.0) + Iapp)
	dx[2] = (1/STG_tau_mNa(V)) * (STG_mNa_inf(V) - mNa)
	dx[3] = (1/STG_tau_hNa(V)) * (STG_hNa_inf(V) - hNa)
	dx[4] = (1/STG_tau_mCaT(V)) * (STG_mCaT_inf(V) - mCaT)
	dx[5] = (1/STG_tau_hCaT(V)) * (STG_hCaT_inf(V) - hCaT)
	dx[6] = (1/STG_tau_mCaS(V)) * (STG_mCaS_inf(V) - mCaS)
	dx[7] = (1/STG_tau_hCaS(V)) * (STG_hCaS_inf(V) - hCaS)
	dx[8] = (1/STG_tau_mA(V)) * (STG_mA_inf(V) - mA)
	dx[9] = (1/STG_tau_hA(V)) * (STG_hA_inf(V) - hA)
	dx[10] = (1/STG_tau_mKCa(V)) * (STG_mKCa_inf(V, Ca) - mKCa)
	dx[11] = (1/STG_tau_mKd(V)) * (STG_mKd_inf(V) - mKd)
	dx[12] = (1/STG_tau_mH(V)) * (STG_mH_inf(V) - mH)
	dx[13] = (-0.94*gCaT*mCaT^3*hCaT^1*(V - 80.0) + -0.94*gCaS*mCaS^3*hCaS^1*(V - 80.0) + -Ca + 0.05) / 20.0
end</code></pre><p>Note that a small adapation of <code>STG_ODE.jl</code> had been realized so that the name of the gating functions match the actual ones.</p><h2 id="Simulating-the-controlled-STG-model"><a class="docs-heading-anchor" href="#Simulating-the-controlled-STG-model">Simulating the controlled STG model</a><a id="Simulating-the-controlled-STG-model-1"></a><a class="docs-heading-anchor-permalink" href="#Simulating-the-controlled-STG-model" title="Permalink"></a></h2><p>As in Fyon et al., 2023 &quot;Reliable neuromodulation from adaptive control of ion channel expression&quot;, the STG model slow and ultraslow DICs can be controlled by the slow calcium and A-type potassium currents to achieve a robust tonic spiking to bursting transition. </p><p>The next few lines of code show how to simulate such controlled STG model using <em>NmodController.jl</em>.</p><pre><code class="language-julia hljs"># First writing controlled ODE function file
writeControlledODEs(STG_spiking, [&quot;CaS&quot;, &quot;A&quot;], [&quot;s&quot;, &quot;u&quot;], filename=&quot;ControlledSTG_ODE.jl&quot;)

# Including the newly written file
include(&quot;ControlledSTG_ODE.jl&quot;)

# Definition of simulation time (in ms)
Tfinal = 5000
tspan  = (0., Tfinal)

# Definition of membrane capacitance and maximal conductance values
gNa   = 4000. # Sodium current maximal conductance
gCaT  = 3. # T-type calcium current maximal conductance
gCaS  = 4. # Slow calcium current maximal conductance
gA    = 175. # A-type potassium current maximal conductance
gKCa  = 110. # Calcium-activated potassium current maximal conductance
gKd   = 137. # Delayed-rectifier potassium current maximal conductance
gH    = 0.3 # H-current maximal conductance
gleak = 0.01 # Leak current maximal conductance
C = 1. # Membrane capacitance

# Input current definition (always a function of time)
Iapp(t) = 0.

# Definition of controller parameters
α = 5e-3 # Rate of transfer between intracellular and membrane
β = 5e-3 # Rate of degradation of intracellular proteins
Kp = 3e-4 # Proprtional gain
Ki = 5e-6 # Integral gain
gsth(t) = 5. - 13 * (t &gt; 500) # Reference gs(Vth)
guth(t) = 4. # Reference gu(Vth)

# Parameter vector for simulations
p = (Iapp, gNa, gCaT, gKCa, gKd, gH, gleak, C, α, β, Kp, Ki, STG_S_spiking(STG_Vth), gsth, guth)

# Initial conditions
V0  = -70.
Ca0 = 0.5
x0  = [V0, STG_mNa_inf(V0), STG_hNa_inf(V0), STG_mCaT_inf(V0), STG_hCaT_inf(V0), STG_mCaS_inf(V0), 
      STG_hCaS_inf(V0), STG_mA_inf(V0), STG_hA_inf(V0), STG_mKCa_inf(V0, Ca0), STG_mKd_inf(V0), STG_mH_inf(V0), Ca0,
      gCaS, gCaS, 0, gA, gA, 0]

# Simulation
prob = ODEProblem(ControlledSTG_ODE, x0, tspan, p) # Describing the problem
sol  = solve(prob) # Solving the problem

# Retrieving variables
tt        = 0. : 0.2 : Tfinal
x         = sol(tt)
V_plot    = x[1, :]
gCaS_plot = x[15, :]
gA_plot   = x[18, :]

# Plot
p1 = plot(tt/1e3, V_plot, xlims=(0, 5), xticks=[0, 5], ylims=(-100, 60), yticks=[-100, 60], linewidth=1.5, 
          legend=false, size=(600, 200), color=:gray30)
ylabel!(&quot;V (mV)&quot;)
p2 = plot(tt/1e3, gCaS_plot, xlims=(0, 5), xticks=[0, 5], ylims=(0, 20), yticks=[0, 20], linewidth=1.5, 
          legend=false, size=(600, 200), color=:gray30)
ylabel!(&quot;gCaS&quot;)
p3 = plot(tt/1e3, gA_plot, xlims=(0, 5), xticks=[0, 5], ylims=(0, 200), yticks=[0, 200], linewidth=1.5, 
          legend=false, size=(600, 200), color=:gray30)
ylabel!(&quot;gA&quot;)
xlabel!(&quot;t (s)&quot;)
CC = plot(p1, p2, p3, layout=(3, 1), size=(900, 600), margins=10px, dpi=500)</code></pre><p><img src="https://raw.githubusercontent.com/arthur-fyon/NmodController.jl/main/docs/src/assets/STG_simu_spiking_controlled.png" alt/></p><p>with <code>ControlledSTG_ODE.jl</code> containing</p><pre><code class="language-julia hljs">#=
	This file contains differential equations describing the controlled CB model of interest
=#

# Function that outputs values of variables derivatives
function ControlledSTG_ODE(dx, x, p, t)
	# Parameters
	Iapp = p[1](t) # Time dependent applied current
	gNa = p[2] # Maximum conductance of current Na
	gCaT = p[3] # Maximum conductance of current CaT
	gKCa = p[4] # Maximum conductance of current KCa
	gKd = p[5] # Maximum conductance of current Kd
	gH = p[6] # Maximum conductance of current H
	gleak = p[7] # Leakage conductance
	C = p[8] # Membrane capacitance
	α = p[9] # Rate of transfer between intracellular and membrane
	β = p[10] # Rate of degradation of intracellular proteins
	Kp = p[11] # Proportional gain
	Ki = p[12] # Integral gain
	SVth = p[13] # Sensitivity matrix at threshold voltage
	gsth = p[14](t) # Reference gs(Vth)
	guth = p[15](t) # Reference gu(Vth)

	# Variables
	V = x[1] # Membrane voltage
	mNa = x[2] # Activation gating variable of current Na
	hNa = x[3] # Inactivation gating variable of current Na
	mCaT = x[4] # Activation gating variable of current CaT
	hCaT = x[5] # Inactivation gating variable of current CaT
	mCaS = x[6] # Activation gating variable of current CaS
	hCaS = x[7] # Inactivation gating variable of current CaS
	mA = x[8] # Activation gating variable of current A
	hA = x[9] # Inactivation gating variable of current A
	mKCa = x[10] # Activation gating variable of current KCa
	mKd = x[11] # Activation gating variable of current Kd
	mH = x[12] # Activation gating variable of current H
	Ca = x[13] # Ca concentration
	gCaSi = x[14] # Intracellular maximum conductance of current CaS
	gCaS = x[15] # Maximum conductance of current CaS
	zCaS = x[16] # Integral variable of current CaS
	gAi = x[17] # Intracellular maximum conductance of current A
	gA = x[18] # Maximum conductance of current A
	zA = x[19] # Integral variable of current A

	# ODEs
	dx[1] = (1/C) * (- gNa*mNa^3*hNa^1*(V - 50.0) -
					   gCaT*mCaT^3*hCaT^1*(V - 80.0) -
					   gCaS*mCaS^3*hCaS^1*(V - 80.0) -
					   gA*mA^3*hA^1*(V - -80.0) -
					   gKCa*mKCa^4*(V - -80.0) -
					   gKd*mKd^4*(V - -80.0) -
					   gH*mH^1*(V - -20.0) -
					   gleak*(V - -50.0) + Iapp)
	dx[2] = (1/STG_tau_mNa(V)) * (STG_mNa_inf(V) - mNa)
	dx[3] = (1/STG_tau_hNa(V)) * (STG_hNa_inf(V) - hNa)
	dx[4] = (1/STG_tau_mCaT(V)) * (STG_mCaT_inf(V) - mCaT)
	dx[5] = (1/STG_tau_hCaT(V)) * (STG_hCaT_inf(V) - hCaT)
	dx[6] = (1/STG_tau_mCaS(V)) * (STG_mCaS_inf(V) - mCaS)
	dx[7] = (1/STG_tau_hCaS(V)) * (STG_hCaS_inf(V) - hCaS)
	dx[8] = (1/STG_tau_mA(V)) * (STG_mA_inf(V) - mA)
	dx[9] = (1/STG_tau_hA(V)) * (STG_hA_inf(V) - hA)
	dx[10] = (1/STG_tau_mKCa(V)) * (STG_mKCa_inf(V, Ca) - mKCa)
	dx[11] = (1/STG_tau_mKd(V)) * (STG_mKd_inf(V) - mKd)
	dx[12] = (1/STG_tau_mH(V)) * (STG_mH_inf(V) - mH)
	dx[13] = (-0.94*gCaT*mCaT^3*hCaT^1*(V - 80.0) + -0.94*gCaS*mCaS^3*hCaS^1*(V - 80.0) + -Ca + 0.05) / 20.0

	# Retrieving which line of the sensitivity matrix matter
	timescales = [2, 3]

	# Retrieving which column of the sensitivity matrix belong to unmodulated conductances
	unmodulated = [1, 2, 5, 6, 7]

	# Retrieving which column of the sensitivity matrix belong to modulated conductances
	modulated = [3, 4]

	# Computing the right hand side of the linear system
	gDICr = [gsth, guth]
	gDICr = gDICr - SVth[timescales, unmodulated] * collect(p[2:6])

	# Computing the left hand side of the linear system
	Smod = SVth[timescales, modulated]

	# Computing the solution of the linear system
	g_r = \(Smod, gDICr)

	# Error signals and control inputs
	eCaS = g_r[1] - gCaS
	uCaS = Kp * eCaS + Ki * zCaS
	eA = g_r[2] - gA
	uA = Kp * eA + Ki * zA

	# ODEs of the controller
	dx[14] = α * gCaS - α * gCaSi - β * gCaSi + uCaS
	dx[15] = α * gCaSi - α * gCaS
	dx[16] = eCaS
	dx[17] = α * gA - α * gAi - β * gAi + uA
	dx[18] = α * gAi - α * gA
	dx[19] = eA
end</code></pre><p>Note that a small adapation of <code>ControlledSTG_ODE.jl</code> had been realized so that the name of the gating functions match the actual ones.</p><h2 id="Simulating-the-uncontrolled-DA-model"><a class="docs-heading-anchor" href="#Simulating-the-uncontrolled-DA-model">Simulating the uncontrolled DA model</a><a id="Simulating-the-uncontrolled-DA-model-1"></a><a class="docs-heading-anchor-permalink" href="#Simulating-the-uncontrolled-DA-model" title="Permalink"></a></h2><p>Once the DA model is initialized, simulated it can be simplified using <em>NmodController.jl</em>. At first, we will simulate the model <code>DA_spiking</code> that exhibits a tonic spiking behavior with</p><ul><li>sodium current: <span>$\bar{g}_\mathrm{Na} =$</span> 30;</li><li>delayed rectified potassium current: <span>$\bar{g}_\mathrm{Kd} =$</span> 5;</li><li>L-type calcium current: <span>$\bar{g}_\mathrm{CaL} =$</span> 0.03;</li><li>N-type calcium current: <span>$\bar{g}_\mathrm{CaN} =$</span> 0.03;</li><li>ERG current: <span>$\bar{g}_\mathrm{ERG} =$</span> 0.12;</li><li>NMDA current: <span>$\bar{g}_\mathrm{NMDA} =$</span> 0.1;</li><li>leakage current: <span>$g_\mathrm{leak} =$</span> 0.01.</li></ul><p>The next few lines of code show how to simulate the spiking DA model using <em>NmodController.jl</em>.</p><pre><code class="language-julia hljs"># First writing uncontrolled ODE function file
writeUncontrolledODEs(DA_spiking, filename=&quot;DA_ODE.jl&quot;)

# Including the newly written file
include(&quot;DA_ODE.jl&quot;)

# Definition of simulation time (in ms)
Tfinal = 5000
tspan  = (0., Tfinal)

# Definition of membrane capacitance and maximal conductance values
gNa   = 30. # Sodium current maximal conductance
gKd   = 5. # Delayed-rectifier potassium current maximal conductance
gCaL  = 0.03 # L-type calcium current maximal conductance
gCaN  = 0.03 # N-type calcium current maximal conductance
gERG  = 0.12 # ERG current maximal conductance
gNMDA  = 0.1 # NMDA current maximal conductance
gleak = 0.01 # Leak current maximal conductance
C = 1. # Membrane capacitance
Mg = 1.4 # Magnesium concentration

# Input current definition (always a function of time)
Iapp(t) = 0.

# Parameter vector for simulations
p = (Iapp, gNa, gKd, gCaL, gCaN, gERG, gNMDA, gleak, C, Mg)

# Initial conditions
V0 = -90.
x0  = [V0, DA_mNa_inf(V0), DA_hNa_inf(V0), DA_mKd_inf(V0), DA_mCaL_inf(V0), DA_mCaN_inf(V0), 0., 0.]

# Simulation
prob = ODEProblem(DA_ODE, x0, tspan, p) # Describing the problem
sol  = solve(prob) # Solving the problem

# Retrieving variables
tt        = 0. : 0.2 : Tfinal
x         = sol(tt)
V_plot   = x[1, :]

# Plot
p = plot(tt/1e3, V_plot, xlims=(0, 5), xticks=[0, 5], ylims=(-100, 60), yticks=[-100, 60], linewidth=1.5, 
          legend=false, size=(600, 200), color=:gray30, margins=20px, dpi=500)
ylabel!(&quot;V (mV)&quot;)
xlabel!(&quot;t (s)&quot;)</code></pre><p><img src="https://raw.githubusercontent.com/arthur-fyon/NmodController.jl/main/docs/src/assets/DA_simu_spiking.png" alt/></p><p>with <code>DA_ODE.jl</code> containing</p><pre><code class="language-julia hljs">#=
	This file contains differential equations describing the CB model of interest
=#

# Function that outputs values of variables derivatives
function DA_ODE(dx, x, p, t)
	# Parameters
	Iapp = p[1](t) # Time dependent applied current
	gNa = p[2] # Maximum conductance of current Na
	gKd = p[3] # Maximum conductance of current Kd
	gCaL = p[4] # Maximum conductance of current CaL
	gCaN = p[5] # Maximum conductance of current CaN
	gERG = p[6] # Maximum conductance of current ERG
	gNMDA = p[7] # Maximum conductance of current NMDA
	gleak = p[8] # Leakage conductance
	C = p[9] # Membrane capacitance
	Mg = p[10] # Mg concentration

	# Variables
	V = x[1] # Membrane voltage
	mNa = x[2] # Activation gating variable of current Na
	hNa = x[3] # Inactivation gating variable of current Na
	mKd = x[4] # Activation gating variable of current Kd
	mCaL = x[5] # Activation gating variable of current CaL
	mCaN = x[6] # Activation gating variable of current CaN
	oERG = x[7] # ERG potassium current activation
	iERG = x[8] # ERG current intermediate

	# ODEs
	dx[1] = (1/C) * (- gNa*mNa^3*hNa^1*(V - 60.0) -
					   gKd*mKd^3*(V - -85.0) -
					   gCaL*mCaL^2*(V - 60.0) -
					   gCaN*mCaN^1*(V - 60.0) -
					   gERG*oERG^1*(V - -85.0) -
					   gNMDA*DA_NMDA_inf(V, Mg)^1*(V - 0.0) -
					   gleak*(V - -50.0) + Iapp)
	dx[2] = (1/DA_tau_mNa(V)) * (DA_mNa_inf(V) - mNa)
	dx[3] = (1/DA_tau_hNa(V)) * (DA_hNa_inf(V) - hNa)
	dx[4] = (1/DA_tau_mKd(V)) * (DA_mKd_inf(V) - mKd)
	dx[5] = (1/DA_tau_mCaL(V)) * (DA_mCaL_inf(V) - mCaL)
	dx[6] = (1/DA_tau_mCaN(V)) * (DA_mCaN_inf(V) - mCaN)
	dx[7] = a0ERG(V) * (1-oERG-iERG) + biERG(V) * iERG - oERG * (aiERG(V)+b0ERG(V))
    dx[8] = aiERG(V) * oERG - biERG(V) * iERG
end
</code></pre><p>Note that a small adapation of <code>DA_ODE.jl</code> had been realized so that the name of the gating functions match the actual ones. Moreover, NMDA current had been changed to be instantaneaous (no gating variable dynamic) and the ERG gating variable dynamics were corrected since this current dynamic is non conventional.</p><h2 id="Simulating-the-controlled-DA-model"><a class="docs-heading-anchor" href="#Simulating-the-controlled-DA-model">Simulating the controlled DA model</a><a id="Simulating-the-controlled-DA-model-1"></a><a class="docs-heading-anchor-permalink" href="#Simulating-the-controlled-DA-model" title="Permalink"></a></h2><p>The DA model slow and ultraslow DICs can be controlled by the L-type and N-type calcium currents to achieve a robust tonic spiking to bursting transition. </p><p>The next few lines of code show how to simulate such controlled DA model using <em>NmodController.jl</em>.</p><pre><code class="language-julia hljs"># First writing controlled ODE function file
writeControlledODEs(DA_spiking, [&quot;CaL&quot;, &quot;CaN&quot;], [&quot;s&quot;, &quot;u&quot;], filename=&quot;ControlledDA_ODE.jl&quot;)

# Including the newly written file
include(&quot;ControlledDA_ODE.jl&quot;)

# Definition of simulation time (in ms)
Tfinal = 10000
tspan  = (0., Tfinal)

# Definition of membrane capacitance and maximal conductance values
gNa   = 30. # Sodium current maximal conductance
gKd   = 5. # Delayed-rectifier potassium current maximal conductance
gCaL  = 0.03 # L-type calcium current maximal conductance
gCaN  = 0.03 # N-type calcium current maximal conductance
gERG  = 0.12 # ERG current maximal conductance
gNMDA  = 0.1 # NMDA current maximal conductance
gleak = 0.01 # Leak current maximal conductance
C = 1. # Membrane capacitance

# Input current definition (always a function of time)
Iapp(t) = 0.

# Definition of controller parameters
α = 5e-3 # Rate of transfer between intracellular and membrane
β = 5e-3 # Rate of degradation of intracellular proteins
Kp = 3e-4 # Proprtional gain
Ki = 5e-6 # Integral gain
gsth(t) = 0.5 - 4.5 * (t &gt; 2000) # Reference gs(Vth)
guth(t) = 5. # Reference gu(Vth)

# Parameter vector for simulations
p = (Iapp, gNa, gKd, gERG, gNMDA, gleak, C, Mg, α, β, Kp, Ki, DA_S_spiking(DA_Vth), gsth, guth)

# Initial conditions
V0 = -90.
x0  = [V0, DA_mNa_inf(V0), DA_hNa_inf(V0), DA_mKd_inf(V0), DA_mCaL_inf(V0), DA_mCaN_inf(V0), 0., 0.,
      gCaL, gCaL, 0, gCaN, gCaN, 0]

# Simulation
prob = ODEProblem(ControlledDA_ODE, x0, tspan, p) # Describing the problem
sol  = solve(prob) # Solving the problem

# Retrieving variables
tt        = 0. : 0.2 : Tfinal
x         = sol(tt)
V_plot    = x[1, :]
gCaL_plot = x[10, :]
gCaN_plot   = x[13, :]

# Plot
p1 = plot(tt/1e3, V_plot, xlims=(0, 10), xticks=[0, 10], ylims=(-100, 60), yticks=[-100, 60], linewidth=1.5, 
          legend=false, size=(600, 200), color=:gray30)
ylabel!(&quot;V (mV)&quot;)
p2 = plot(tt/1e3, gCaL_plot, xlims=(0, 10), xticks=[0, 10], ylims=(0, 0.06), yticks=[0, 0.06], linewidth=1.5, 
          legend=false, size=(600, 200), color=:gray30)
ylabel!(&quot;gCaL&quot;)
p3 = plot(tt/1e3, gCaN_plot, xlims=(0, 10), xticks=[0, 10], ylims=(0, 0.2), yticks=[0, 0.2], linewidth=1.5, 
          legend=false, size=(600, 200), color=:gray30)
ylabel!(&quot;gCaN&quot;)
xlabel!(&quot;t (s)&quot;)
CC = plot(p1, p2, p3, layout=(3, 1), size=(900, 600), margins=10px, dpi=500)</code></pre><p><img src="https://raw.githubusercontent.com/arthur-fyon/NmodController.jl/main/docs/src/assets/DA_simu_spiking_controlled.png" alt/></p><p>with <code>ControlledDA_ODE.jl</code> containing</p><pre><code class="language-julia hljs">#=
	This file contains differential equations describing the controlled CB model of interest
=#

# Function that outputs values of variables derivatives
function ControlledDA_ODE(dx, x, p, t)
	# Parameters
	Iapp = p[1](t) # Time dependent applied current
	gNa = p[2] # Maximum conductance of current Na
	gKd = p[3] # Maximum conductance of current Kd
	gERG = p[4] # Maximum conductance of current ERG
	gNMDA = p[5] # Maximum conductance of current NMDA
	gleak = p[6] # Leakage conductance
	C = p[7] # Membrane capacitance
	Mg = p[8] # Mg concentration
	α = p[9] # Rate of transfer between intracellular and membrane
	β = p[10] # Rate of degradation of intracellular proteins
	Kp = p[11] # Proportional gain
	Ki = p[12] # Integral gain
	SVth = p[13] # Sensitivity matrix at threshold voltage
	gsth = p[14](t) # Reference gs(Vth)
	guth = p[15](t) # Reference gu(Vth)

	# Variables
	V = x[1] # Membrane voltage
	mNa = x[2] # Activation gating variable of current Na
	hNa = x[3] # Inactivation gating variable of current Na
	mKd = x[4] # Activation gating variable of current Kd
	mCaL = x[5] # Activation gating variable of current CaL
	mCaN = x[6] # Activation gating variable of current CaN
	oERG = x[7] # ERG potassium current activation
	iERG = x[8] # ERG current intermediate
	gCaLi = x[9] # Intracellular maximum conductance of current CaL
	gCaL = x[10] # Maximum conductance of current CaL
	zCaL = x[11] # Integral variable of current CaL
	gCaNi = x[12] # Intracellular maximum conductance of current CaN
	gCaN = x[13] # Maximum conductance of current CaN
	zCaN = x[14] # Integral variable of current CaN

	# ODEs
	dx[1] = (1/C) * (- gNa*mNa^3*hNa^1*(V - 60.0) -
					   gKd*mKd^3*(V - -85.0) -
					   gCaL*mCaL^2*(V - 60.0) -
					   gCaN*mCaN^1*(V - 60.0) -
					   gERG*oERG^1*(V - -85.0) -
					   gNMDA*DA_NMDA_inf(V, Mg)^1*(V - 0.0) -
					   gleak*(V - -50.0) + Iapp)
	dx[2] = (1/DA_tau_mNa(V)) * (DA_mNa_inf(V) - mNa)
	dx[3] = (1/DA_tau_hNa(V)) * (DA_hNa_inf(V) - hNa)
	dx[4] = (1/DA_tau_mKd(V)) * (DA_mKd_inf(V) - mKd)
	dx[5] = (1/DA_tau_mCaL(V)) * (DA_mCaL_inf(V) - mCaL)
	dx[6] = (1/DA_tau_mCaN(V)) * (DA_mCaN_inf(V) - mCaN)
	dx[7] = a0ERG(V) * (1-oERG-iERG) + biERG(V) * iERG - oERG * (aiERG(V)+b0ERG(V))
    dx[8] = aiERG(V) * oERG - biERG(V) * iERG

	# Retrieving which line of the sensitivity matrix matter
	timescales = [2, 3]

	# Retrieving which column of the sensitivity matrix belong to unmodulated conductances
	unmodulated = [1, 2, 5, 6]

	# Retrieving which column of the sensitivity matrix belong to modulated conductances
	modulated = [3, 4]

	# Computing the right hand side of the linear system
	gDICr = [gsth, guth]
	gDICr = gDICr - SVth[timescales, unmodulated] * collect(p[2:5])

	# Computing the left hand side of the linear system
	Smod = SVth[timescales, modulated]

	# Computing the solution of the linear system
	g_r = \(Smod, gDICr)

	# Error signals and control inputs
	eCaL = g_r[1] - gCaL
	uCaL = Kp * eCaL + Ki * zCaL
	eCaN = g_r[2] - gCaN
	uCaN = Kp * eCaN + Ki * zCaN

	# ODEs of the controller
	dx[9] = α * gCaL - α * gCaLi - β * gCaLi + uCaL
	dx[10] = α * gCaLi - α * gCaL
	dx[11] = eCaL
	dx[12] = α * gCaN - α * gCaNi - β * gCaNi + uCaN
	dx[13] = α * gCaNi - α * gCaN
	dx[14] = eCaN
end</code></pre><p>Note that a small adapation of <code>ControlledDA_ODE.jl</code> had been realized so that the name of the gating functions match the actual ones. Moreover, NMDA current had been changed to be instantaneaous (no gating variable dynamic) and the ERG gating variable dynamics were corrected since this current dynamic is non conventional.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../files/">« How to write ODE functions file?</a><a class="docs-footer-nextpage" href="../../typesMethodsFunctions/">Types/Methods/Functions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.0.0 on <span class="colophon-date" title="Friday 15 September 2023 12:53">Friday 15 September 2023</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
